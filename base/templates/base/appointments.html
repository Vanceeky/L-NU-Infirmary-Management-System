{% extends 'base.html' %}


{% block title %} Appointments {% endblock %}


{% block css %}


{% endblock %}

{% block content %}

<div class="row">
    <div class="col-md-9 mt-4">
       <div class="card">
          <div class="card-header pb-0 px-3 d-flex justify-content-between align-items-center">
          
                <h6 class="mb-0">Today's Appointment  
                    ( <i class="far fa-user me-2" aria-hidden="true"></i>{{ appointments.count }} )</h6>
               
        
                
                    <a id="notify-button" href="#" class="btn btn-sm bg-gradient-secondary cursor-pointer" type="button" onclick="confirmDoctorAvailability()">Notify Patients</a>

            

          </div>
          <div class="card-body pt-4 p-3">
            {% if all_cancelled %}
               <div class="alert alert-warning text-center text-white">
                  <strong>Note:</strong> All appointments scheduled for today are canceled due to the doctor's unavailability.
               </div>
               {% else %}
               {% if appointments %}
                  <div class="table-responsive">
                     <table class="table align-items-center mb-0">
                        <thead>
                           <tr>
                              <th class="text-uppercase text-center text-secondary text-xxs font-weight-bolder opacity-7">ID</th>
                              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Patient</th>
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Category</th>
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Reason</th>
                              
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                              <th class="text-secondary opacity-7"></th>
                           </tr>
                        </thead>
                        <tbody>
                           {% for ap in appointments %}

                              <tr>
                                 <td class="text-center">
                                 <span class="text-secondary text-xs font-weight-bold">{{ ap.id }}</span>
                                 </td>

                                 <td>
                                 <div class="d-flex px-2 py-1">
                                    <div>
                                          <img src="{{ ap.patient.avatar.url }}" class="avatar avatar-sm me-3" alt="user1">
                                    </div>
                                    <div class="d-flex flex-column justify-content-center">
                                          <h6 class="mb-0 text-sm text-capitalize">{{ ap.patient.user.first_name}} {{ ap.patient.user.last_name}} ({{ap.patient.gender}}, {{ ap.patient.age}})</h6>
                                          <p class="text-xs text-secondary mb-0">{{ ap.patient.user.email }}</p>
                                    </div>
                                 </div>
                                 </td>
                                 <td class="text-center">
                                 <p class="text-xs font-weight-bold mb-0">{{ ap.patient.category}}</p>
                                 <p class="text-xs text-secondary mb-0">{{ ap.patient.designation }}</p>
                                 </td>
                                 <td class="align-middle text-center text-sm">
                                 <span class="">{{ ap.reason|slice:":10" }}.....</span>
                                 </td>

                                 <td class="align-middle text-center text-sm">
                                    <span class="badge bg-gradient-warning"> {{ ap.status }} </span>
                                 </td>

                                 <td class="align-middle">
                                 <a href="javascript:;" class="text-secondary font-weight-bold text-xs mx-2" data-bs-toggle="tooltip" data-bs-title="View patient">
                                 <i class="fa fa-user-edit"></i>
                                 </a>
                                 <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-bs-toggle="tooltip" data-bs-title="Delete">
                                    <i class="fa fa-trash"></i>
                                    </a>
                                 </td>
                              </tr>

                           {% endfor %}


                        </tbody>
                     </table>
                  </div>
               {% else %}

                  <p class="text-center">No Appointments incoming today </p>
               {% endif %}
               
            {% endif %}
         </div>
       </div>
    </div>
    <div class="col-md-3 mt-4">
       <div class="card h-auto mb-4">
          <div class="card-header pb-0 px-3">
            
             
                   <h6 class="mb-0">Current Patient Status</h6>
              

           
          </div>
          <div class="card-body pt-4 p-3">
             <h6 class="text-uppercase text-body text-xs font-weight-bolder mb-3">Under Evalutation:</h6>

             <ul class="list-group">
               {% if has_in_progress_appointments %}
               {% for ap in in_progress_appointments %}
               <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
                  <div class="d-flex align-items-center">
                     <button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 btn-sm d-flex align-items-center justify-content-center"><i class="fa fa-user-edit" aria-hidden="true"></i></button>
                     <div class="d-flex flex-column">
                        <h6 class="mb-1 text-dark text-sm">{{ ap.patient.user.first_name }} {{ ap.patient.user.last_name}}</h6>
                        <span class="text-xs">{{ ap.patient.category }} / {{ ap.patient.designation}} </span>
                     </div>
                  </div>
                  <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                     <i class="fa fa-user-edit"></i>
                  </div>
               </li>
               {% endfor %}
               {% else %}
                   <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
                       <div class="d-flex align-items-center">
                           <div class="d-flex flex-column">
                               <h6 class="mb-1 text-dark text-sm">No appointments in progress</h6>
                           </div>
                       </div>
                   </li>
               {% endif %}

             </ul>
             <h6 class="text-uppercase text-body text-xs font-weight-bolder my-3">In Queue: </h6>
             <ul class="list-group">

               {% if has_in_queue_appointments %}
               {% for ap in in_queue_appointments %}
                       <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
                           <div class="d-flex align-items-center">
                               <button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 btn-sm d-flex align-items-center justify-content-center">
                                   <i class="fa fa-spinner" aria-hidden="true"></i>
                               </button>
                               <div class="d-flex flex-column">
                                   <h6 class="mb-1 text-dark text-sm">{{ ap.patient.user.first_name }} {{ ap.patient.user.last_name}}</h6>
                                   <span class="text-xs">{{ ap.patient.category }} / {{ ap.patient.designation}}</span>
                               </div>
                           </div>
                           <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                               <i class="fa-solid fa-circle-check"></i>
                           </div>
                       </li>
                       {% endfor %}
                       {% else %}
                           <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
                               <div class="d-flex align-items-center">
                                   <div class="d-flex flex-column">
                                       <h6 class="mb-1 text-dark text-sm">No appointments in queue</h6>
                                   </div>
                               </div>
                           </li>
                       {% endif %}


                

             </ul>
          </div>
       </div>
    </div>
</div>

{% endblock %}

{% block js %}

<script>
   function confirmDoctorAvailability() {
       // Check if the button should be enabled
       

       // Disable the button to prevent multiple clicks
       $('#notify-button').prop('disabled', true);

       Swal.fire({
           title: 'Confirm Doctor Availability',
           text: 'Is the doctor available for appointments today?',
           icon: 'question',
           showCloseButton: true,  // Add close button to the modal
           showCancelButton: true,  // Add cancel button
           confirmButtonText: 'Yes',
           cancelButtonText: 'Cancel Appointments',
           allowOutsideClick: false,
           confirmButtonColor: "#3085d6",
           cancelButtonColor: "#d33",
         
           didClose: () => {
               // Re-enable the button when the modal is closed
               $('#notify-button').prop('disabled', false);
           }
       }).then((result) => {
           if (result.isConfirmed) {
               // Doctor is available, show loading indicator
               Swal.fire({
                   html: '<i class="fa fa-spinner fa-spin fa-3x"></i> <br> <span>Sending notifications. Please wait...</span>',
                   showConfirmButton: false,
                   allowOutsideClick: false
               });

               $.ajax({
                   url: "{% url 'appointment-reminder' %}",
                   method: "GET",
                   success: function(data) {
                       Swal.fire({
                           title: 'Success',
                           text: 'Notifications have been sent successfully.',
                           icon: 'success',
                           timer: 1000,
                           timerProgressBar: true,
                           showConfirmButton: false
                       }).then(() => {
                           location.reload();
                       });
                   },
                   error: function(xhr) {
                       let errorMessage = 'An error occurred while sending the notification.';
                       if (xhr.status === 404) {
                           errorMessage = 'The requested resource was not found.';
                       } else if (xhr.status === 500) {
                           errorMessage = 'Internal server error. Please try again later.';
                       }
                       Swal.fire({
                           title: 'Error',
                           text: errorMessage,
                           icon: 'error'
                       });
                   },
                   complete: function() {
                       $('#notify-button').prop('disabled', false);
                   }
               });
           } else if (result.dismiss === Swal.DismissReason.cancel) {
               // Doctor is not available, show loading indicator for cancellation
               Swal.fire({
                   html: '<i class="fa fa-spinner fa-spin fa-3x"></i> <br> <span>Sending cancellation notifications. Please wait...</span>',
                   showConfirmButton: false,
                   allowOutsideClick: false
               });

               $.ajax({
                   url: "{% url 'cancel-appointment-reminder' %}",
                   method: "GET",
                   success: function(data) {
                       Swal.fire({
                           title: 'Success',
                           text: 'Cancellation notifications have been sent successfully.',
                           icon: 'success',
                           timer: 1000,
                           timerProgressBar: true,
                           showConfirmButton: false
                       }).then(() => {
                           // Store the timestamp of the button click
                           location.reload();
                       });
                   },
                   error: function(xhr) {
                       let errorMessage = 'An error occurred while sending the cancellation notification.';
                       if (xhr.status === 404) {
                           errorMessage = 'The requested resource was not found.';
                       } else if (xhr.status === 500) {
                           errorMessage = 'Internal server error. Please try again later.';
                       }
                       Swal.fire({
                           title: 'Error',
                           text: errorMessage,
                           icon: 'error'
                       });
                   },
                   complete: function() {
                       $('#notify-button').prop('disabled', false);
                   }
               });
           }
       });
   }


</script>


<!--
<script>
   function confirmDoctorAvailability() {
       // Check if the button should be enabled
       const now = new Date().getTime();
       const lastClicked = localStorage.getItem('lastClicked');
       let enableTime = new Date().setHours(24, 0, 0, 0); // Next midnight

       if (lastClicked) {
           enableTime = parseInt(lastClicked, 10) + (24 * 60 * 60 * 1000); // 24 hours from last clicked
       }

       if (now < enableTime) {
           Swal.fire({
               title: 'Limit Reached',
               text: 'You can only send notifications once a day. Please wait until tomorrow.',
               icon: 'info',
               confirmButtonText: 'OK'
           });
           return;
       }

       // Disable the button to prevent multiple clicks
       $('#notify-button').prop('disabled', true);

       Swal.fire({
           title: 'Confirm Doctor Availability',
           text: 'Is the doctor available for appointments today?',
           icon: 'question',
           showCloseButton: true,  // Add close button to the modal
           showCancelButton: true,  // Add cancel button
           confirmButtonText: 'Yes',
           cancelButtonText: 'Cancel Appointments',
           allowOutsideClick: false,
           didClose: () => {
               // Re-enable the button when the modal is closed
               $('#notify-button').prop('disabled', false);
           }
       }).then((result) => {
           if (result.isConfirmed) {
               // Doctor is available, show loading indicator
               Swal.fire({
                   html: '<i class="fa fa-spinner fa-spin fa-3x"></i> <br> <span>Sending notifications. Please wait...</span>',
                   showConfirmButton: false,
                   allowOutsideClick: false
               });

               $.ajax({
                   url: "{% url 'appointment-reminder' %}",
                   method: "GET",
                   success: function(data) {
                       Swal.fire({
                           title: 'Success',
                           text: 'Notifications have been sent successfully.',
                           icon: 'success',
                           timer: 1000,
                           timerProgressBar: true,
                           showConfirmButton: false
                       }).then(() => {
                           // Store the timestamp of the button click
                           localStorage.setItem('lastClicked', now);
                           location.reload();
                       });
                   },
                   error: function(xhr) {
                       let errorMessage = 'An error occurred while sending the notification.';
                       if (xhr.status === 404) {
                           errorMessage = 'The requested resource was not found.';
                       } else if (xhr.status === 500) {
                           errorMessage = 'Internal server error. Please try again later.';
                       }
                       Swal.fire({
                           title: 'Error',
                           text: errorMessage,
                           icon: 'error'
                       });
                   },
                   complete: function() {
                       $('#notify-button').prop('disabled', false);
                   }
               });
           } else if (result.dismiss === Swal.DismissReason.cancel) {
               // Doctor is not available, show loading indicator for cancellation
               Swal.fire({
                   html: '<i class="fa fa-spinner fa-spin fa-3x"></i> <br> <span>Sending cancellation notifications. Please wait...</span>',
                   showConfirmButton: false,
                   allowOutsideClick: false
               });

               $.ajax({
                   url: "{% url 'cancel-appointment-reminder' %}",
                   method: "GET",
                   success: function(data) {
                       Swal.fire({
                           title: 'Success',
                           text: 'Cancellation notifications have been sent successfully.',
                           icon: 'success',
                           timer: 1000,
                           timerProgressBar: true,
                           showConfirmButton: false
                       }).then(() => {
                           // Store the timestamp of the button click
                           localStorage.setItem('lastClicked', now);
                           location.reload();
                       });
                   },
                   error: function(xhr) {
                       let errorMessage = 'An error occurred while sending the cancellation notification.';
                       if (xhr.status === 404) {
                           errorMessage = 'The requested resource was not found.';
                       } else if (xhr.status === 500) {
                           errorMessage = 'Internal server error. Please try again later.';
                       }
                       Swal.fire({
                           title: 'Error',
                           text: errorMessage,
                           icon: 'error'
                       });
                   },
                   complete: function() {
                       $('#notify-button').prop('disabled', false);
                   }
               });
           }
       });
   }

   // Check if the button should be disabled on page load
   $(document).ready(function() {
       const now = new Date().getTime();
       const lastClicked = localStorage.getItem('lastClicked');
       const enableTime = lastClicked ? parseInt(lastClicked, 10) + (24 * 60 * 60 * 1000) : new Date().setHours(24, 0, 0, 0);

       if (now < enableTime) {
           $('#notify-button').prop('disabled', true);
       }
   });
</script>
-->


{% endblock %}